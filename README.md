# obs_autobuild_test
Test to see how you make OpenSUSE build services build automagically with GitHub

But first, a rant
-----------------
OpenSus build service is a great tool, but...
* There is a lot of technically correct documentation that doesn't actually tell you how to do stuff
* The build process is fragile
* Error messages are cryptic
* It is a b*tch to debug if you have not got your own instance of open build service (which I do not)

I tried to get this going for my project Seccubus (www.seccubus.com) but failed miserably. So, I turned to 
creating this GitHub project to have a simple basis to test out how to get all the parts moving correctly.
I blew several days just to get this working, but am now at a stage where it actually works and I can try to 
fix this for Seccubus again.


Steps I took
============

Setting up an obs container
---------------------------
* Created and empty repo at https://github.com/seccubus/obs_autobuild_test
* Created a new obs package container https://build.opensuse.org/package/show/home:seccubus/obs_autobuild_test
* checked out the obs container
```
$ osc checkout obs_autobuild_test
A    obs_autobuild_test
At revision None.
$
```

Downloading the content of my GitHub Repo
-----------------------------------------
In the obs container I created a file called _services with the following content. (For the full content see: https://github.com/seccubus/obs_autobuild_test/blob/master/obs/_service)
```
<services>
  <!--
    This block downloads you source as a tar archive from github
    -->
  <service name="tar_scm">
    <param name="scm">git</param>
    <param name="url">https://github.com/seccubus/obs_autobuild_test</param>
    <param name="filename">obs-autobuild-test</param>
  </service>
</services>
```

If a built is triggered this section of the services file makes sure that the source is downloaded from GitHub and packed into a tar file with the name obs-autobuild-test.xxx.yyy.tar

Setting the version correctly
-----------------------------
The version numbers generated by tar_scm are a bit odd by default, and we want them to look prettier so I added the following line to the tar_scm service block

```
    <param name="versionformat">@PARENT_TAG@.@TAG_OFFSET@</param>
```

@PARENT_TAG@ will be replaced by the closest tag to the current commit. @TAG_OFFSET@ will be replaced by a by the number of commits since the tag was added to the branch. Currently you have to make sure that the tag is fully numeric (e.g. 1.0) in stead of the style recommended by GitHub (v1.0), because in this case set_version will break and you will see this error:

    Files could not be expanded: Running /usr/lib/obs/service/set_version - -outdir /lxc.tmp.29937/out

If you tag you local repository make sure you use annotated tags (see: https://git-scm.com/book/en/v2/Git-Basics-Tagging#Annotated-Tags) and push them to you upstream repo like this:

```
$ git tag -a 0.6 -m "This will be version 0.6"
$ git push origin 0.6
Counting objects: 1, done.
Writing objects: 100% (1/1), 179 bytes | 0 bytes/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To git@github.com:seccubus/obs_autobuild_test.git
 * [new tag]         0.6 -> 0.6
```
or if you want to push multiple tags in one go
```
$ git tag -a 0.7 -m "This will be version 0.7"
$ git push origin --tags
Counting objects: 1, done.
Writing objects: 100% (1/1), 179 bytes | 0 bytes/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To git@github.com:seccubus/obs_autobuild_test.git
 * [new tag]         0.4 -> 0.4
 * [new tag]         0.7 -> 0.7
 ```

The full services file now looks like this:
```
<services>
  <!--
    This block downloads you source as a tar archive from github

    Be aware that the tag should always start with a number
    (See https://github.com/openSUSE/obs-service-set_version/issues/30 for details)

    If you start with a letter, you will see this error:

    Files could not be expanded: Running /usr/lib/obs/service/set_version - -outdir /lxc.tmp.29937/out
    -->
  <service name="tar_scm">
    <param name="scm">git</param>
    <param name="url">https://github.com/seccubus/obs_autobuild_test</param>
    <param name="versionformat">@PARENT_TAG@.@TAG_OFFSET@</param>
    <param name="filename">obs-autobuild-test</param>
  </service>
</services>
```



Make GitHub trigger a build
---------------------------
* created a token
```
$ osc token --create home:seccubus obs_autobuild_test
Create a new token
<status code="ok">
  <summary>Ok</summary>
  <data name="token">ReDaCtEdReDaCtEdReDaCtEdReDaCtEd</data>
</status>
```


Information I based this on
=========================== 
* http://openbuildservice.org/2013/11/22/Source-Update-Via_Token/ - Very sketchy and incomplete
* http://openbuildservice.org/help/manuals/obs-reference-guide/cha.obs.source_service.html - Not very usefull almost internal developer style documentation
* https://en.opensuse.org/openSUSE:Build_Service_Concept_SourceService - Still too high level
* https://en.opensuse.org/openSUSE:Build_Service_private_instance_software_live_cycle - Pretty decent docs. Managed to trigger a build that grabs the software from scm, but then I got stuck
* https://forums.opensuse.org/showthread.php/501869-How-to-define-these-kinds-of-version-format-in-OpenSUSE-Build-Service - Also helpful
* irc://irc.freenode.net/openSUSE-buildservice - Open Build Service IRC channel was very helpful
* https://en.opensuse.org/openSUSE:Build_Service_Debian_builds#Minimum_set_of_files_required_to_create_.deb - Information on how to make a deb package